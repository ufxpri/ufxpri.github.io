디커플링 어플리테이션, SQS, SNS, Kinesis, Active MQ

어플리케이션 간 커플링을 제거한다.
- SQS: queue model
- SNS: pub/sub model
- Kinesis: real-time streaming model


Amazon SQS
심플 큐 서비스
완전 관리형 서비스이다.
- 무제한 처리량
- 메시지 유지 기간 기본 4일, 최대 14일
- < 10ms
- 256KB 이하
- 메시지가 2번 이상 전송될 수 있음

메시지 생산자
SDK를 사용해 SendMessage 로 데이터를 전송한다.
무제한 처리량을 자랑한다.

메시지 소비자
EC2, Lambda 사용 가능
consumer 는 polling 으로 데이터를 가져온다.
데이터를 처리한 이후에는 DeleteMessage API 를 사용하여 메시지를 제거한다.
소비자는 여러개가 될 수 있다.
만약 한 소비자가 메시지를 처리하지 못하고 일정시간이 지나면 메시지를 다른 소비자가 가져갈 수 있다.
그래서 메시지를 반드시 삭제해야 한다.
CloudWatch Metric - Queue Length 를 기반으로 ASG의 사이즈를 조절할 수 있다.
"ApproximateNumberOfMessages"
이 값을 기반으로 CloudWatch Alarm 을 생성한 뒤
ASG의 사이즈를 조절하도록 설정한다.

SQS 는 어플리케이션 간 작업을 분리하는데 사용됨

암호화
- https 를 통해 통신이 암호화됨
- KMS 암호화
- 클라이언트 측 암호화

엑세스 제어: IAM 정책으로 제어 가능함
SQS 접근 규칙: s3의 버킷 정책과 비슷함


message visibility timeout
측정 메시지가 consumer에게 가져가지면 그 이후 30초동안 visibility가 제한된다(삭제되는것이 아니다).
30초가 지나면 메시지는 큐에서 다시 가져갈 수 있게 된다.
12시간 까지 설정 가능
"ChangeMessageVisibility"를 api를 통해 호출하여 더 많은 시간을 할당받을 수 있도록 할 수 있다.


LongPolling
메시지를 요청하는데 메시지가 없으면 샐생길때까지 폴링을 할 수 있다.
지연시간을 줄이고 처리 효율성을 극적으로 높힐 수 있다.


FIFO Queue
메시지에 순서가 있는 큐 이다.
처리량에 제한이 있다.
- 배칭을 사용하지 않을 시: 300msg/s
- 배칭을 사용할 시: 3000msg/s
중복제거가 가능함
사용자에게 순서대로 처리되는것을 보장할 수 있음


SQS with ASG
CloudWatch Metric을 통해서 가져갈 설정
CloudWatch Alarm이 이벤트를 수신하면 스케일링 수행
ASG는 인스턴스 수를 관리

사례
DB에 데이터를 저장하는 작업이 있는데 중간에 오류가 발생한다면 데이터를 잃어버리게 됨
그래서 SQS에 먼저 데이터를 저장하고 DB작업을 수행하면 오류가 발생해도 데이터를 잃어버리지 않고 유지할 수 있음



Amazon Simple Notification Service (Amazon SNS)
- event producer: SNS 토픽으로 메시지를 보내기만 한다.
- event receivers: SNS 토픽에서 받고싶은 토픽을 구독할 수 있다.
- 12,500,000 토픽 당 구독 수
- 100,000 토픽 제한
subscriber
- SQS
- Lambda
- Kinesis Data Firehose
- Emails
- SMS
- HTTP(S) Endpoints

publisher
- CloudWatch Alarms
- AWS Budgets
- Lambda
- Auto Scaling Group
- S3 Bucket
- DynamoDB
- CloudFormation
- AWS DMS
- RDS Events

토픽 퍼블리시: SDK 를 사용해서 토픽을 만들고 구독을 한다. 그리고 토픽을 전송한다.
직접 퍼블리시: 플랫폼 어플리케이션을 생성, 플랫폼 엔드포인트를 생성, 플랫폼 엔드포인트에 배포, 다른 서비스들과 연계 가능


FanOut
하나의 이벤트를 여러개의 서비스가 수신할 수 있도록 하기 위해선 Queue 를 여러개 만들어야 한다.
SNS로 이벤트를 수신해서 분배하고 서비스마다 각각의 SQS가 이벤트를 수신하여 서비스로 전달한다.
이를 FanOut 패턴이라고 한다.
리전간 전달도 가능함


Kinesis
데이터를 쉽게 수집하고 처리할 수 있음.
- Kinesis Data Stream: 데이터 스트림을 수신, 처리, 저장 할 수 있음
- Kinesis Data Firehose: AWS data stores에 데이터 저장
- Kinesis Data Analytics: SQL 또는 Apache Flink를 사용하여 데이터 분석
- Kinesis Video Streams: 비디오 스트림을 수신, 처리, 저장 할 수 있음

Kinesis Data Stream
스트림은 여러개의 샤드로 구성된다.
샤드는 사전에 설정해야 하며 데이터가 분산되서 저장된다.
producer가 있어서 레코드 라고 하는 데이터를 전송한다.
레코드는 partition key 와 Data Blob(최대 1MB) 로 구성되어 있다.
1MS/sec per shard
1000msg/sec per shard
consumer도 있어서 데이터를 가져간다.
레코드는 partition key 와 Sequence no., Data Blob으로 구성되어 있다.
2MB/sec (shard) per shard
2MB/sec (enhanced) per shard per consumer
보존 기간은 1일에서 365일까지
- Provisioned mode: 사전에 용량을 예약하여 사용
- On-demand mode: 지난달 사용량에 따라 2배까지 늘어남
보안
IAM 정책사용 가능
KMS로 암호화 가능
VPC Endpoint를 사용하여 연결 가능
https 사용 안전

Kinesis DataFirehose
거의 모든 서비스로부터 데이터 수집 가능.
producer 는 1MB 이하의 데이터를 수신 가능
lambda 연결 가능
batch writes 로 consumer가 동작함. 수신처는 총 3가지 종류
- S3
- Redshift
- ElasticSearch
제3자 소프트웨어와 연결도 가능함
- 자체 API Endpoint
완전 관리형 서비스이다.
FireHose를 통과하는 데이터에 대해서만 비용을 받음
60초의 레이턴시 near real-time (중요)
최소 1MB데이터가 되야 전송이됨
DataStreams 와 DataFirehose 를 구분하는 문제가 많이나옴

Kinesis 에서 Queue 의 FIFO 를 구현하는 방법에 대해서 알아본다.
partition key를 사용하여 데이터가 전달되는 샤드를 지정할 수 있다.
partition key는 해싱되어 하나의 샤드에 전송된다. 그래서 같은 partition key는 같은 샤드에 전송되는것을 보장할 수 있다.

(좀 위에 있긴 하지만) SQS는 GroupID 로 메시지가 전송되는 그룹을 지정할 수 있음


SQS SNS Kinesis


MQ
공개된 기술인 MQ를 사용하는 경우 쓸 수 있는 서비스
MQTT, AMQP, STOMP, Openwire, WSS
EFS 를 이용해 데이터를 저장하고 꺼내쓰기때문에 HA 구성이 가능하다.