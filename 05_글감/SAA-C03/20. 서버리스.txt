Lambda
서버리스에 대해 공부한다.
서버를 프로비져닝 라지 않는것을 대부분 서버리스라고 함
- AWS Lambda
- DynamoDB
- AWS Cognito
- AWS API Gateway
- Amazon S3
- AWS SNS & SQS
- AWS Kinesis Data Firehose
- Aurora Serverless
- Step Functions
- Fargate
위 목록이 서버리스 서비스에 해당함

Lambda는 다음과 같은 특성을 가지고 있음
- 모든 AWS 서비스와 연동이 가능함
- 다양한 프로그래밍 언어를 지원
- AWS CloudWatch 를 통해 모니터링
- function당 리소스를 할당하기 쉬워짐
- RAM사용량 확장시 CPU와 network도 향상됨

Lambda Container Image
람다에 컨테이너를 사용해야 할 경우
컨테이너 이미지가 Lambda Runtime API 를 지원해야함

다른서비스와 연계
- API Gateway
- Kinesis
- DynamoDB
- S3
- CloudFront
- CloudWatch Events EventBridge
- CloudWatch Logs
- SNS
- SQS
- Cognito

Lambda 한도
- 실행제한
	- 메모리 128MB - 10GB
	- 최대 15분 실행시간
	- 환경변수 4KB
	- function container 안 디스크 크기 512MB~10GB
	- 동시호출 1000
- 배포제한
	- 압축 사이즈 50MB이하
	- 비압축+의존성 사이즈 250MB이하
	- /tmp 위치에 시작 파일 업로드 가능
	- 환경변수 4KB (업로드 할 때)


Lambda & CloudFront Function
엣지펑션 엣지 로케이션에서 작업을 처리할 수 도 있음
- CloudFront Functions
	- 사용자와의 통신에서 요청 및 응답을 수정할 수 있음
	- 1ms 이하의 실행만 가능
	- million 요청
	- 캐싱, 헤더조작, url 수정, 요청 인증(jwt등)
- Lambda@Edge
	- 사용자 및 서버의 통신에서 요청 및 응답을 수정할 수 있음
	- 10s 이하의 실행만 가능
	- thousands 요청
	- 코드 그 자체, http body를 수정할 수 있음


Lambda네트워트
기본적으로 VPC 내부에 엑세스 할 수 없다. (외부에 있으니까)
이를 해결하려면 VPC 내에서 Lambda를 실행하면 된다.

RDS 프록시
여러개의 람다와 연결되면 커넥션 제한이 생길 수 있다. 그래서 프록시 사용이 필수가 된다.

반대로 RDS & Aurora에서 Lambda function을 호출하는 경우도 있다.
- lambda function으로 향하는 outbound를 허용해야한다. (Public, Nat GW, VPC endpoint)
- DB instance는 호출 권한을 가지고 있어야 한다. (lambda resource-based policy & IAM Policy)

RDS Event Notification 과는 다른 기능임을 알고 있어야 한다. 이들은 이벤트는 받지만 그 안의 데이터에는 접근이 불가능하다.


DynamoDB
- 몇 밀리초 안에 처리가 가능함
- IAM과 연동되어 있음
Standard
Infrequant access

아이템의 최대 크기는 400KB 이다.
(중요) 스키마를 빠르게 전개해야 할 때 다른 서비스보다 월등히 좋음

읽기/쓰기 캐패시티를 설정한다.
- Provisioned Mode (default)
	- 읽기와 쓰기 용량을 설정한 만큼 지불
	- 사용량이 일정하게 예측할 수 있는 경우 추천
- On-Demand Mode
	- 실제 통신이 이루어진 경우에만 지불
	- 매우 적은량의 통신 또는 몇초안에 사용율이 spike를 보이는 경우 추천 (provisioned mode 는 순간 spike에 불리함)

DynamoDB Accelerator (DAX)
- 캐싱을 통해 읽기 데이터 접근 개선
- 캐싱된 데이터는 밀리초 안에 반환
- 캐싱된 데이터는 5분동안 유지됨 (기본)
- ElasticCache 와 비교하면 ElasticCache는 집계 데이터를 저장하는 등에 적합하고 DAX 는 개별 데이터에 빠르게 접근하는데 유리하다. 그래서 DynamoDB를 쓰는경우 DAX를 사용하는게 더 일반적이다.

StreamProcessing
아이템 단위의 일련의 작업 계획을 만들 수 있다.
- DynamoDB streams
	24시간 retention
- Kinesis Data Stream (newer)
	1년 retention

global table 기능을 사용하면 여러 리전에서 테이블 사용이 가능하다.
DynamoDB Stream을 pre-requisite 으로 설정해야만 한다.

아이템 자체에 TTL 설정이 가능하다.

재해복구를 위한 데이터 백업
- Continuous backup using point-in-time recovery (PITR)
	지난 35시간의 데이터 백업
	복구 과정에서 새 테이블을 생성함
- On-demand backups
	장기간 보존에 사용
	퍼포먼스에 영향을 주지 않음
	AWS Backup 에서 관리할 수 있음
	복구 과정에서 새 테이블을 생성함

S3와 연계
PIRT을 이용해 s3로 데이터 전송 가능
데이터 분석을 위해 S3로 데이터를 보낼 수 있음
S3에서 데이터를 가져오는 것도 가능함
ION 또는 JSON 포멧이 사용됨


API Gateway
클라이언트가 Lambda function에 접근하려면 IAM 권한이 필요하다
그래서 이를 대신해줄 API Gateway 를 사용해야 한다.
API key를 생성하거나 swagger를 통해 생성할 수 도 있음
- Lambda Function
- HTTP
- AWS Service
거의 모든 api를 노출시킬 수 있음

Endpoint Type
- Edge-Optimized (default)
	CloudFront Edge locations를 통해 요청이 들어옴
	여전히 한개의 리전에서만 서비스되긴함
- Regional
	같은 리전에 있는 사용자를 위함
	CloudFront 와 연계될 수 있음 (기본은 아님)
- Private
	VPC 안의 서비스들만 연결할 수 있음
	VPC endpoint (ENI) 를 통해서 접근 가능

보안설정
- 사용자 인증
	- IAM Role (내부 사용자들을 위함)
	- Cognito (유저 식별)
	- Custom Authorizer (나만의 로직 jwt 같은거)
- HTTPS
	- AWS Certificate Manager (ACM)을 통한 보안 준수
	- Edge-Optimized endpoint사용시 인증은 무조건 us-east-1 에 있어야 함
	- Regional endpoint사용시 인증은 무조건 API Gateway region에서 이루어져야 함
	- Route 53에 CNAME 또는 A-alias 가 설정되어 있어야 함


AWS Step Function
복잡한 워크플로우를 만들어 aws에서 실행 시킬 수 있는 편리한 도구
- 다양한 서비스와 연동 가능함 EC2, ECS, On-premises, API Gateway, SQS, etc...
- 중간에 사람이 개입하는 작업을 추가할 수 도 있음


Amazon Cognito
외부 사용자에게 인증을 부여할 때 사용됨
- Cognito User Pools
	- 앱 사용자를 위한 인증 기능
	- API Gateway & Application Load Balancer와 연동됨
- Cognito Identity Pools
	- AWS 인증을 부여함 따라서 AWS 서비스에 직접 접근 가능
	- Cognito User Pools와 연동하여 인증 제공자로 사용 가능
- Cognito vs IAM
	- "hundreds of users"
	- "mobile users"
	- "authenticate with SAML"
	위 키워드가 나오면 Cognito가 적합함

Cognito User Pools (CUP)
- User Feature
모바일과 웹 사용자를 위한 인증 데이터베이스 생성해준다.
이메일, 패스워드 인증으로 로그인 가능
MFA 설정이 가능하며 Facebook, Google, SAML등과 연동 가능
- Integrations
1. 사용자가 CUP로 직접 인증을 요청하여 토큰을 받아와 API Gateway 호출에 사용할 수 있다.
2. 사용자가 요청하면 ALB에서 CUP로 인증을 넘겨 인증되면 사용할 수 있다.

Cognito Identity Pools (CIP)
AWS서비스에 임시 접근 권한을 부여할 수 있음
제 3자 인증으로 사용가능
API Gateway 를 통해 AWS 서비스에 직접적인 엑세스 가능
Cognito 안에 IAM 정책이 적용되어 있음
user_id 기반으로 세부 설정 가능
Default IAM roles 를 설정할 수 있음
이는 마치 임시 IAM 정책을 할당받는 것과 같음 CUP는 할 수 없는 영역 (둘이 사용 용도자체가 다르다)

